name: Approve Production Deployment

# This workflow triggers when deploy-approved label is added to approval issues
# It parses the issue metadata and continues the deployment process

on:
  issues:
    types: [labeled]

  # Allow manual testing of approval workflow
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to approve'
        required: true
        type: number

permissions:
  contents: write # Required for creating tags and releases
  actions: read
  id-token: write
  issues: write

jobs:
  gate:
    name: Verify Approval
    # Only run when deploy-approved label is added to approval issues OR manual trigger
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.issue.pull_request == null &&
       (github.event.issue.user.login == 'github-actions[bot]' || contains(github.event.issue.user.login, 'github-actions')) &&
       contains(join(github.event.issue.labels.*.name), 'deploy-approval') &&
       github.event.label.name == 'deploy-approved')
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      env_name: ${{ steps.parse.outputs.env_name }}
      run_id: ${{ steps.parse.outputs.run_id }}
      image_tag: ${{ steps.parse.outputs.image_tag }}
      release_version: ${{ steps.parse.outputs.release_version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fetch issue data (for manual trigger)
        if: github.event_name == 'workflow_dispatch'
        id: fetch_issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.inputs.issue_number }}
            });
            return issue.data.body;
          result-encoding: string

      - name: Parse approval issue
        id: parse
        uses: ./.github/actions/parse-approval-issue
        with:
          issue_body: ${{ github.event_name == 'workflow_dispatch' && steps.fetch_issue.outputs.result || github.event.issue.body }}

      - name: Validate parsed data
        run: |
          echo "‚úÖ Approval issue parsed successfully"
          echo "Environment: ${{ steps.parse.outputs.env_name }}"
          echo "Run ID: ${{ steps.parse.outputs.run_id }}"
          echo "Image Tag: ${{ steps.parse.outputs.image_tag }}"
          echo "Release Version: ${{ steps.parse.outputs.release_version }}"

          # Validate required fields
          if [ -z "${{ steps.parse.outputs.env_name }}" ]; then
            echo "‚ùå Error: Could not parse environment name from issue"
            exit 1
          fi

          if [ -z "${{ steps.parse.outputs.run_id }}" ]; then
            echo "‚ùå Error: Could not parse run ID from issue"
            exit 1
          fi

          if [ -z "${{ steps.parse.outputs.image_tag }}" ]; then
            echo "‚ùå Error: Could not parse image tag from issue"
            exit 1
          fi

      - name: Add deployment comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üöÄ **Deployment Approved**\n\nStarting production deployment...\n\n- Environment: \`${{ steps.parse.outputs.env_name }}\`\n- Image Tag: \`${{ steps.parse.outputs.image_tag }}\`\n- Release: \`${{ steps.parse.outputs.release_version }}\`\n- Approved by: @${{ github.actor }}\n\n[View deployment workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            });

  deploy:
    name: Deploy to Production
    needs: gate
    uses: ./.github/workflows/deploy-reusable.yml
    with:
      environment: prod
      image-tag-suffix: prod-latest
      deployment-reason: ${{ format('Approved deployment - Release {0}', needs.gate.outputs.release_version) }}
      release-version: ${{ needs.gate.outputs.release_version }}
      skip-health-checks: false
      pre-built-image-tag: ${{ needs.gate.outputs.image_tag }}
    secrets: inherit

  # ============================================================================
  # JOB 3: CREATE GITHUB RELEASE (After Successful Deployment)
  # ============================================================================
  create-release:
    name: Create GitHub Release
    needs: [gate, deploy]
    # Only create release if deployment was successful (including health checks)
    if: needs.deploy.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write # Required for creating tags and releases
      issues: write # For updating approval issue with release link

    outputs:
      tag_name: ${{ steps.generate.outputs.tag_name }}
      release_url: ${{ steps.create-release.outputs.result }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history needed for changelog generation

      - name: Generate release notes
        id: generate
        uses: ./.github/actions/generate-release-notes
        with:
          release-version: ${{ needs.gate.outputs.release_version }}
          image-tag: ${{ needs.gate.outputs.image_tag }}
          source-branch: ${{ github.event_name == 'workflow_dispatch' && 'manual-trigger' || github.ref_name }}

      - name: Create Git tag
        run: |
          echo "üè∑Ô∏è  Creating Git tag: ${{ steps.generate.outputs.tag_name }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create annotated tag
          git tag -a "${{ steps.generate.outputs.tag_name }}" -m "Release ${{ steps.generate.outputs.tag_name }}"

          # Push tag to repository
          git push origin "${{ steps.generate.outputs.tag_name }}"

          echo "‚úÖ Tag created and pushed successfully"

      - name: Create GitHub Release
        id: create-release
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const tagName = '${{ steps.generate.outputs.tag_name }}';
            const releaseNotes = `${{ steps.generate.outputs.release_notes }}`;
            const releaseVersion = '${{ needs.gate.outputs.release_version }}';

            console.log('üì¶ Creating GitHub Release...');
            console.log(`Tag: ${tagName}`);
            console.log(`Version: ${releaseVersion}`);

            try {
              const release = await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tagName,
                name: `Release ${tagName}`,
                body: releaseNotes,
                draft: false,
                prerelease: false,
                generate_release_notes: false // We generate our own
              });
              
              console.log('‚úÖ Release created successfully');
              console.log(`Release URL: ${release.data.html_url}`);
              
              // Return URL as string result
              return release.data.html_url;
            } catch (error) {
              console.error('‚ùå Failed to create release:', error);
              core.setFailed(`Failed to create GitHub Release: ${error.message}`);
              throw error;
            }

      - name: Generate release summary
        if: always()
        run: |
          echo "# üì¶ GitHub Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.create-release.outcome }}" = "success" ]; then
            echo "## ‚úÖ Release Created Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Tag**: \`${{ steps.generate.outputs.tag_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "**Release**: ${{ steps.create-release.outputs.result }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üìã Release Details" >> $GITHUB_STEP_SUMMARY
            echo "- Version: \`${{ needs.gate.outputs.release_version }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Image Tag: \`${{ needs.gate.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- Changelog: ${{ steps.generate.outputs.changelog_url }}" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.generate.outputs.previous_tag }}" != "NONE" ]; then
              echo "- Previous Release: \`${{ steps.generate.outputs.previous_tag }}\`" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## ‚ùå Release Creation Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for error details." >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # JOB 4: UPDATE APPROVAL ISSUE (Final Status)
  # ============================================================================
  update-issue:
    name: Update Approval Issue
    needs: [gate, deploy, create-release]
    # Only run if gate job ran (not skipped) - ensures we only comment on valid approvals
    if: always() && needs.gate.result != 'skipped'
    runs-on: ubuntu-latest
    timeout-minutes: 2
    permissions:
      issues: write

    steps:
      - name: Update issue with result
        uses: actions/github-script@v7
        with:
          script: |
            const deploySuccess = '${{ needs.deploy.result }}' === 'success';
            const releaseSuccess = '${{ needs.create-release.result }}' === 'success';
            const emoji = deploySuccess ? '‚úÖ' : '‚ùå';
            const status = deploySuccess ? 'SUCCESSFUL' : 'FAILED';

            let body = `${emoji} **Deployment ${status}**\n\n`;
            body += `- Environment: \`${{ needs.gate.outputs.env_name }}\`\n`;
            body += `- Image Tag: \`${{ needs.gate.outputs.image_tag }}\`\n`;
            body += `- Release Version: \`${{ needs.gate.outputs.release_version }}\`\n`;
            body += `- Result: ${status}\n\n`;

            // Add release information if created successfully
            if (releaseSuccess) {
              body += `### üì¶ GitHub Release Created\n\n`;
              body += `- **Tag**: \`${{ needs.create-release.outputs.tag_name }}\`\n`;
              body += `- **Release**: ${{ needs.create-release.outputs.release_url }}\n\n`;
            } else if ('${{ needs.create-release.result }}' === 'failure') {
              body += `### ‚ö†Ô∏è GitHub Release Creation Failed\n\n`;
              body += `The deployment was successful but release creation failed. Check workflow logs.\n\n`;
            }

            body += `[View deployment details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

            // Close the issue if deployment was successful
            if (deploySuccess) {
              await github.rest.issues.update({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'closed',
                state_reason: 'completed'
              });
            }
