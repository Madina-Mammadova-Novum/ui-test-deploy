@startuml CI/CD Architecture Overview
!theme plain

title ShipLink Frontend - Workflow Architecture & Interconnections

skinparam componentStyle rectangle
skinparam linetype ortho

' ========================================
' LEGEND
' ========================================

legend top right
  |= Color |= Meaning |
  |<#3B82F6> | PR Validation |
  |<#8B5CF6> | Commit Validation |
  |<#10B981> | Build & Registry |
  |<#14B8A6> | Deployment |
  |<#F59E0B> | Health Checks |
  |<#EF4444> | Validation/Rollback |
  |<#E5E7EB> | External Services |
endlegend

' ========================================
' EXTERNAL SERVICES
' ========================================

package "External Services" #E5E7EB {
    component "Azure Container\nRegistry (ACR)" as ACR {
        database "Docker Images" as Images {
            artifact "shiplink-frontend:SHA" as ImageSHA
            artifact "shiplink-frontend:dev-latest" as ImageDev
            artifact "shiplink-frontend:stage-latest" as ImageStage
            artifact "shiplink-frontend:prod-latest" as ImageProd
            artifact "shiplink-frontend:release-*" as ImageRelease
        }
    }
    
    node "DEV Server" as DevServer {
        component "Docker Engine" as DevDocker
        component "Container\nshiplink-frontend" as DevContainer
    }
    
    node "STAGE Server" as StageServer {
        component "Docker Engine" as StageDocker
        component "Container\nshiplink-frontend" as StageContainer
    }
    
    node "PROD Server" as ProdServer {
        component "Docker Engine" as ProdDocker
        component "Container\nshiplink-frontend" as ProdContainer
    }
}

' ========================================
' GITHUB ENVIRONMENTS
' ========================================

package "GitHub Environments" {
    rectangle "Environment: DEV" as EnvDev {
        storage "Secrets (45)" as DevSecrets {
            file "Registry (3)"
            file "SSH (4)"
            file "Application (38)"
        }
        file "Protection: None"
    }
    
    rectangle "Environment: STAGE" as EnvStage {
        storage "Secrets (45)" as StageSecrets {
            file "Registry (3)"
            file "SSH (4)"
            file "Application (38)"
        }
        file "Protection: Optional"
    }
    
    rectangle "Environment: PROD" as EnvProd {
        storage "Secrets (45)" as ProdSecrets {
            file "Registry (3)"
            file "SSH (4)"
            file "Application (38)"
        }
        file "Protection: Required\nReviewers: 1+\nBranch: main"
    }
}

' ========================================
' CI WORKFLOWS (PR PHASE)
' ========================================

package "Continuous Integration" #LightBlue {
    
    ' PR Validation Workflow
    component "pr-validation.yml" as PRWorkflow #3B82F6 {
        rectangle "Trigger:\npull_request\n(any branch)" as PRTrigger
        
        package "Jobs (Parallel)" {
            rectangle "Code Quality & Build\n• ESLint\n• Prettier\n• Build\n• Tests\nTimeout: 15min" as JobQuality
            rectangle "Security Scan\n• yarn audit\n• Vulnerabilities\nTimeout: 10min" as JobSecurity
            rectangle "Performance\n• Bundle analysis\nTimeout: 5min" as JobPerf
        }
        
        rectangle "Optimizations:\n• Cache v4\n• Path filtering\n• Draft skip" as PROptim
        
        PRTrigger --> JobQuality
        PRTrigger --> JobSecurity
        PRTrigger --> JobPerf
    }
    
    ' Commit Validation Workflow
    component "commit-validation.yml" as CommitWorkflow #8B5CF6 {
        rectangle "Trigger:\npull_request\n(to develop)" as CommitTrigger
        rectangle "Validate Commits\n• Commitlint\n• Conventional format\nTimeout: 5min" as JobCommit
        CommitTrigger --> JobCommit
    }
}

' ========================================
' CD WORKFLOWS (DEPLOYMENT PHASE)
' ========================================

package "Continuous Deployment" #LightGreen {
    
    ' Deployment Caller Workflows
    component "deploy-dev.yml" as DeployDevWF #14B8A6 {
        rectangle "Trigger:\npush to develop\nor manual" as DevTrigger
        rectangle "Call Reusable\nenv=dev" as DevCall
        DevTrigger --> DevCall
    }
    
    component "deploy-stage.yml" as DeployStageWF #14B8A6 {
        rectangle "Trigger:\npush to stage\nor manual" as StageTrigger
        rectangle "Call Reusable\nenv=stage" as StageCall
        StageTrigger --> StageCall
    }
    
    component "deploy-prod.yml" as DeployProdWF #EF4444 {
        rectangle "Trigger:\npush to main\n(from release/* or hotfix/*)\nor manual" as ProdTrigger
        rectangle "Validate Source\n• Check branch\n• Extract version\nTimeout: 2min" as ProdValidate
        rectangle "Call Reusable\nenv=prod\n+ release-version" as ProdCall
        
        ProdTrigger --> ProdValidate
        ProdValidate --> ProdCall : if valid
    }
    
    ' Reusable Workflow (Core Logic)
    component "deploy-reusable.yml" as ReusableWF #10B981 {
        rectangle "Inputs:\n• environment\n• image-tag-suffix\n• release-version\n• skip-health-checks" as ReusableInputs
        
        package "Job Sequence" {
            rectangle "Job 1: Build & Push\n• Checkout\n• Login ACR\n• Build Docker\n• Push image\nTimeout: 20min" as JobBuild #10B981
            
            rectangle "Job 2: Deploy\n• SSH to server\n• Pull image\n• Stop old\n• Start new\n• Verify\nTimeout: 10min" as JobDeploy #14B8A6
            
            rectangle "Job 3: Health Checks\n(if env=prod)\n• Wait 60s\n• Test endpoints\n• Auto-rollback\nTimeout: 10min" as JobHealth #F59E0B
        }
        
        rectangle "Outputs:\n• image-tag\n• deployment-time\n• release-version" as ReusableOutputs
        
        ReusableInputs --> JobBuild
        JobBuild --> JobDeploy : needs: build
        JobDeploy --> JobHealth : if prod
    }
}

' ========================================
' CONNECTIONS: CI TO CD
' ========================================

PRWorkflow -[hidden]down-> CommitWorkflow
CommitWorkflow -[hidden]down-> DeployDevWF

' ========================================
' CONNECTIONS: CALLER TO REUSABLE
' ========================================

DevCall -right-> ReusableWF : calls
StageCall -right-> ReusableWF : calls
ProdCall -right-> ReusableWF : calls

' ========================================
' CONNECTIONS: ENVIRONMENTS
' ========================================

ReusableWF ..> EnvDev : reads\nsecrets
ReusableWF ..> EnvStage : reads\nsecrets
ReusableWF ..> EnvProd : reads\nsecrets\n(with approval)

' ========================================
' CONNECTIONS: BUILD TO ACR
' ========================================

JobBuild -down-> ACR : push images
JobBuild --> ImageSHA : creates
JobBuild --> ImageDev : creates
JobBuild --> ImageStage : creates
JobBuild --> ImageProd : creates
JobBuild --> ImageRelease : creates (prod)

' ========================================
' CONNECTIONS: DEPLOY TO SERVERS
' ========================================

JobDeploy -down-> DevServer : if env=dev
JobDeploy -down-> StageServer : if env=stage
JobDeploy -down-> ProdServer : if env=prod

DevDocker --> DevContainer : manages
StageDocker --> StageContainer : manages
ProdDocker --> ProdContainer : manages

DevContainer ..> ACR : pulls from
StageContainer ..> ACR : pulls from
ProdContainer ..> ACR : pulls from

' ========================================
' CONNECTIONS: HEALTH CHECKS
' ========================================

JobHealth -down-> ProdContainer : tests endpoints

' ========================================
' ANNOTATIONS
' ========================================

note right of PRWorkflow
  **Optimizations:**
  • Actions Cache v4
  • ESLint caching
  • Next.js build cache
  • Smart path filtering
  • Draft PR skip
  • Parallel job execution
  
  **Result:**
  • 60% faster PR validation
  • 80% cache hit rate
  • 60% cost savings
end note

note right of ReusableWF
  **Reusable Pattern Benefits:**
  • Single source of truth
  • Consistent deployments
  • Easy to maintain
  • Parameterized execution
  
  **Supported Environments:**
  • dev (auto-deploy)
  • stage (auto-deploy)
  • prod (manual approval)
end note

note bottom of JobHealth
  **Health Check Tests:**
  1. Home Page → 200 OK
  2. API Health → 200 OK
  3. Auth Service → 200/401
  4. Protected API → 401
  
  **On Failure:**
  Automatic rollback to
  previous working version
end note

note right of EnvProd
  **Production Safety:**
  • Manual approval required
  • Branch validation
  • Health checks mandatory
  • Automatic rollback
  • Audit trail
  
  **Allowed Sources:**
  • release/yyyymmdd-count
  • hotfix/*
end note

' ========================================
' STATISTICS BOX
' ========================================

rectangle "Pipeline Statistics" as Stats #FFFACD {
    rectangle "**Node Version:** 22.x\n**Total Workflows:** 5\n**Total Jobs:** 9\n**Environments:** 3" as Stats1
    rectangle "**Secrets per Env:** 45\n**Docker Images:** 5 tags\n**Max Timeout:** 20 min\n**Cache Strategy:** GHA" as Stats2
}

Stats -[hidden]-> DevServer

@enduml

