@startuml CI/CD Architecture Overview
!theme plain

title ShipLink Frontend - Workflow Architecture & Interconnections

skinparam componentStyle rectangle
skinparam linetype ortho
skinparam padding 8
skinparam arrowThickness 2
skinparam defaultFontSize 11

' ========================================
' LEGEND
' ========================================

legend top right
  |= Color |= Meaning |
  |<#3B82F6> | PR Validation |
  |<#8B5CF6> | Commit Validation |
  |<#10B981> | Build & Registry |
  |<#14B8A6> | Deployment |
  |<#F59E0B> | Health Checks |
  |<#EC4899> | Approval & Release |
  |<#EF4444> | Validation/Rollback |
  |<#E5E7EB> | External Services |
endlegend

' ========================================
' EXTERNAL SERVICES
' ========================================

package "External Services" #E5E7EB {
    component "Azure Container\nRegistry (ACR)\n\n" as ACR {
        database "Docker Images\n\n" as Images {
            artifact "shiplink-frontend:SHA\n\n" as ImageSHA
            artifact "shiplink-frontend:dev-latest\n\n" as ImageDev
            artifact "shiplink-frontend:stage-latest\n\n" as ImageStage
            artifact "shiplink-frontend:prod-latest\n\n" as ImageProd
            artifact "shiplink-frontend:release-*\n\n" as ImageRelease
        }
    }
    
    node "DEV Server\n\n" as DevServer {
        component "Docker Engine\n\n" as DevDocker
        component "Container:\nshiplink-frontend\n\n" as DevContainer
    }
    
    node "STAGE Server\n\n" as StageServer {
        component "Docker Engine\n\n" as StageDocker
        component "Container:\nshiplink-frontend\n\n" as StageContainer
    }
    
    node "PROD Server\n\n" as ProdServer {
        component "Docker Engine\n\n" as ProdDocker
        component "Container:\nshiplink-frontend\n\n" as ProdContainer
    }
}

' ========================================
' GITHUB SERVICES
' ========================================

package "GitHub Services" #F0F0FF {
    component "GitHub Releases\n\n" as GitHubReleases {
        artifact "Tags:\nv2025.10.23.1054-SHA\n\n" as ReleaseTags
        artifact "Changelog:\nGrouped by type\n\n" as Changelog
        artifact "Contributors:\n@username list\n\n" as Contributors
    }
    
    component "GitHub Issues\n\n" as GitHubIssues {
        artifact "Approval Issues:\ndeploy-approval\n\n" as ApprovalIssues
        artifact "Labels:\ndeploy-approved\n\n" as ApprovalLabels
    }
}

' ========================================
' GITHUB ENVIRONMENTS
' ========================================

package "GitHub Environments\n\n" {
    rectangle "Environment: DEV\n\n" as EnvDev #DDEEFF {
        storage "Secrets (46)\n\n" as DevSecrets {
            file "Registry (3)\n\n"
            file "SSH (5)\n\n"
            file "Application (38)\n\n"
        }
        file "Protection: None\nAuto-deploy: âœ“\n\n"
    }
    
    rectangle "Environment: STAGE\n\n" as EnvStage #FFFFDD {
        storage "Secrets (46)\n\n" as StageSecrets {
            file "Registry (3)\n\n"
            file "SSH (5)\n\n"
            file "Application (38)\n\n"
        }
        file "Protection: Optional\nAuto-deploy: âœ“\n\n"
    }
    
    rectangle "Environment: PROD\n\n" as EnvProd #FFDDDD {
        storage "Secrets (46)\n\n" as ProdSecrets {
            file "Registry (3)\n\n"
            file "SSH (5)\n\n"
            file "Application (38)\n\n"
        }
        storage "Variables (1)\n\n" as ProdVars {
            file "WAIT_FOR_APPROVAL\n\n"
        }
        file "Protection: Required\nReviewers: 1+\nBranch: main only\nManual approval: âœ“\n\n"
    }
}

' ========================================
' CI WORKFLOWS (PR PHASE)
' ========================================

package "Continuous Integration\n\n" #LightBlue {
    
    ' PR Validation Workflow
    component "pr-validation.yml\n\n" as PRWorkflow #3B82F6 {
        rectangle "Trigger:\npull_request\n(any branch)\n\n" as PRTrigger
        
        package "Jobs (Parallel)\n\n" {
            rectangle "Code Quality\n& Build\n\nâ€¢ ESLint\nâ€¢ Prettier\nâ€¢ Build\nâ€¢ Tests\n\n15 min" as JobQuality #DDEEFF
            rectangle "Security Scan\n\nâ€¢ yarn audit\nâ€¢ Vulnerabilities\n\n10 min" as JobSecurity #DDEEFF
            rectangle "Performance\n\nâ€¢ Bundle analysis\n\n5 min" as JobPerf #DDEEFF
        }
        
        rectangle "Optimizations:\n\nâ€¢ Cache v4\nâ€¢ Path filtering\nâ€¢ Draft skip\n\n" as PROptim #DDFFDD
        
        PRTrigger --> JobQuality
        PRTrigger --> JobSecurity
        PRTrigger --> JobPerf
    }
    
    ' Commit Validation Workflow
    component "commit-validation.yml\n\n" as CommitWorkflow #8B5CF6 {
        rectangle "Trigger:\npull_request\n(to develop)\n\n" as CommitTrigger
        rectangle "Validate Commits\n\nâ€¢ Commitlint\nâ€¢ Conventional format\n\n5 min" as JobCommit #EEDDFF
        CommitTrigger --> JobCommit
    }
}

' ========================================
' CD WORKFLOWS (DEPLOYMENT PHASE)
' ========================================

package "Continuous Deployment\n\n" #LightGreen {
    
    ' Deployment Caller Workflows
    component "deploy-dev.yml\n\n" as DeployDevWF #14B8A6 {
        rectangle "Trigger:\npush to develop\nor manual\n\n" as DevTrigger
        rectangle "Call Reusable\nenv=dev\n\n" as DevCall #DDEEFF
        DevTrigger --> DevCall
    }
    
    component "deploy-stage.yml\n\n" as DeployStageWF #14B8A6 {
        rectangle "Trigger:\npush to stage\nor manual\n\n" as StageTrigger
        rectangle "Call Reusable\nenv=stage\n\n" as StageCall #DDEEFF
        StageTrigger --> StageCall
    }
    
    component "deploy-prod.yml\n\n" as DeployProdWF #EF4444 {
        rectangle "Trigger:\npush to main\n(from release/*\nor hotfix/*)\nor manual\n\n" as ProdTrigger
        rectangle "Validate Source\n\nâ€¢ Check branch\nâ€¢ Extract version\n\n2 min" as ProdValidate #FFEEEE
        rectangle "Build Image\n\nPushes to ACR\nCreates tags\n\n5-8 min" as ProdBuildImage #FFEEEE
        rectangle "Request Approval\n\nCreates issue\nWaits for label\n\n~30 sec" as ProdRequestApproval #FFEEEE
        
        ProdTrigger --> ProdValidate
        ProdValidate --> ProdBuildImage : if valid
        ProdBuildImage --> ProdRequestApproval
    }
    
    ' Approval Workflow
    component "approve-deploy-prod.yml\n\n" as ApproveWF #EC4899 {
        rectangle "Trigger:\nlabel added\n(deploy-approved)\n\n" as ApproveTrigger
        
        package "Job Sequence\n\n" {
            rectangle "1. Verify Approval\n\nParse issue\nExtract metadata\n\n~30 sec" as JobGate #FFEEEE
            
            rectangle "2. Call Reusable\n\nDeploy with\npre-built image\n\n~3-5 min" as JobApproveDeploy #FFEEEE
            
            rectangle "3. Create Release\n\nGenerate notes\nCreate tag\nPublish release\n\n~1-2 min" as JobCreateRelease #FFEEEE
            
            rectangle "4. Update Issue\n\nAdd release link\nClose issue\n\n~10 sec" as JobUpdateIssue #FFEEEE
        }
        
        ApproveTrigger --> JobGate
        JobGate --> JobApproveDeploy
        JobApproveDeploy --> JobCreateRelease : if successful\n+ health checks\npass
        JobCreateRelease --> JobUpdateIssue
    }
    
    ' Reusable Workflow (Core Logic)
    component "deploy-reusable.yml\n\n" as ReusableWF #10B981 {
        rectangle "Inputs:\n\nâ€¢ environment\nâ€¢ image-tag-suffix\nâ€¢ release-version\nâ€¢ skip-health-checks\nâ€¢ pre-built-image-tag\n\n" as ReusableInputs #DDFFDD
        
        package "Job Sequence\n\n" {
            rectangle "Job 1:\nBuild & Push\n\nâ€¢ Checkout\nâ€¢ Login ACR\nâ€¢ Build Docker\nâ€¢ Push image\n\n20 min" as JobBuild #DDFFDD
            
            rectangle "Job 2:\nDeploy\n\nâ€¢ SSH to server\nâ€¢ Pull image\nâ€¢ Stop old\nâ€¢ Start new\nâ€¢ Verify\n\n10 min" as JobDeploy #DDEEFF
            
            rectangle "Job 3:\nHealth Checks\n\n(if env=prod)\nâ€¢ Wait 60s\nâ€¢ Test endpoints\nâ€¢ Auto-rollback\n\n10 min" as JobHealth #FFFFDD
        }
        
        rectangle "Outputs:\n\nâ€¢ image-tag\nâ€¢ deployment-time\nâ€¢ release-version\n\n" as ReusableOutputs #DDFFDD
        
        ReusableInputs --> JobBuild
        JobBuild --> JobDeploy : needs: build
        JobDeploy --> JobHealth : if prod
    }
}

' ========================================
' CUSTOM ACTIONS
' ========================================

package "Custom GitHub Actions\n\n" #FFE0F0 {
    component "generate-release-notes\n\n" as ReleaseNotesAction #EC4899 {
        rectangle "Inputs:\n\nâ€¢ release-version\nâ€¢ image-tag\nâ€¢ source-branch\n\n" as ActionInputs #FFEEEE
        
        rectangle "Processing:\n\nâ€¢ Generate tag name\nâ€¢ Find previous tag\nâ€¢ Parse commits\nâ€¢ Group by type\nâ€¢ Extract PR numbers\nâ€¢ List contributors\nâ€¢ Add metadata\n\n" as ActionProcess #FFEEEE
        
        rectangle "Outputs:\n\nâ€¢ tag-name\nâ€¢ release-notes\nâ€¢ changelog-url\nâ€¢ previous-tag\n\n" as ActionOutputs #FFEEEE
        
        ActionInputs --> ActionProcess
        ActionProcess --> ActionOutputs
    }
    
    component "parse-approval-issue\n\n" as ParseIssueAction #EC4899 {
        rectangle "Inputs:\n\nâ€¢ issue_body\n\n" as ParseInputs #FFEEEE
        
        rectangle "Processing:\n\nâ€¢ Extract env name\nâ€¢ Extract run ID\nâ€¢ Extract image tag\nâ€¢ Extract release version\nâ€¢ Validate fields\n\n" as ParseProcess #FFEEEE
        
        rectangle "Outputs:\n\nâ€¢ env_name\nâ€¢ run_id\nâ€¢ image_tag\nâ€¢ release_version\n\n" as ParseOutputs #FFEEEE
        
        ParseInputs --> ParseProcess
        ParseProcess --> ParseOutputs
    }
}

' ========================================
' CONNECTIONS: CI TO CD
' ========================================

PRWorkflow -[hidden]down-> CommitWorkflow
CommitWorkflow -[hidden]down-> DeployDevWF

' ========================================
' CONNECTIONS: CALLER TO REUSABLE
' ========================================

DevCall -right-> ReusableWF : calls
StageCall -right-> ReusableWF : calls
JobApproveDeploy -right-> ReusableWF : calls\n(with pre-built image)

' ========================================
' CONNECTIONS: ENVIRONMENTS
' ========================================

ReusableWF ..> EnvDev : reads secrets
ReusableWF ..> EnvStage : reads secrets
ReusableWF ..> EnvProd : reads secrets\n(with approval)

' ========================================
' CONNECTIONS: BUILD TO ACR
' ========================================

JobBuild -down-> ACR : push images
JobBuild --> ImageSHA : creates
JobBuild --> ImageDev : creates
JobBuild --> ImageStage : creates
JobBuild --> ImageProd : creates
JobBuild --> ImageRelease : creates (prod)

ProdBuildImage -down-> ACR : push image

' ========================================
' CONNECTIONS: DEPLOY TO SERVERS
' ========================================

JobDeploy -down-> DevServer : if env=dev
JobDeploy -down-> StageServer : if env=stage
JobDeploy -down-> ProdServer : if env=prod

DevDocker --> DevContainer : manages
StageDocker --> StageContainer : manages
ProdDocker --> ProdContainer : manages

DevContainer ..> ACR : pulls from
StageContainer ..> ACR : pulls from
ProdContainer ..> ACR : pulls from

' ========================================
' CONNECTIONS: HEALTH CHECKS
' ========================================

JobHealth -down-> ProdContainer : tests endpoints

' ========================================
' CONNECTIONS: APPROVAL & RELEASE
' ========================================

ProdRequestApproval --> GitHubIssues : creates issue
GitHubIssues --> ApproveWF : triggers\n(label added)
JobGate --> ParseIssueAction : uses action
JobCreateRelease --> ReleaseNotesAction : uses action
ReleaseNotesAction --> GitHubReleases : creates release
JobUpdateIssue --> GitHubIssues : updates issue

' ========================================
' ANNOTATIONS
' ========================================

note right of PRWorkflow
  **Optimizations:**
  â€¢ Actions Cache v4
  â€¢ ESLint caching
  â€¢ Next.js build cache
  â€¢ Smart path filtering
  â€¢ Draft PR skip
  â€¢ Parallel job execution
  
  **Result:**
  â€¢ 60% faster PR validation
  â€¢ 80% cache hit rate
  â€¢ 60% cost savings
end note

note right of ReusableWF
  **Reusable Pattern Benefits:**
  â€¢ Single source of truth
  â€¢ Consistent deployments
  â€¢ Easy to maintain
  â€¢ Parameterized execution
  
  **Supported Environments:**
  â€¢ dev (auto-deploy)
  â€¢ stage (auto-deploy)
  â€¢ prod (manual approval)
end note

note bottom of JobHealth
  **Health Check Tests:**
  1. Home Page â†’ 200 OK
  2. API Health â†’ 200 OK
  3. Auth Service â†’ 200/401
  
  **On Failure:**
  Automatic rollback to
  previous working version
end note

note right of EnvProd
  **Production Safety:**
  â€¢ Manual approval required
  â€¢ Branch validation
  â€¢ Health checks mandatory
  â€¢ Automatic rollback
  â€¢ Audit trail
  â€¢ GitHub Release creation
  
  **Allowed Sources:**
  â€¢ release/yyyymmdd-count
  â€¢ hotfix/*
end note

note bottom of ApproveWF
  **Approval Process:**
  1. PR merged to main
  2. Image built
  3. Issue created
  4. Team reviews
  5. Label added
  6. Deployment starts
  7. Health checks run
  8. Release created
  9. Issue updated
end note

note bottom of ReleaseNotesAction
  **Release Tag Format:**
  v{YYYY}.{MM}.{DD}.{HHMM}-{SHA8}
  
  Example:
  v2025.10.23.1054-f9b4949
  
  **Changelog Sections:**
  âœ¨ Features
  ðŸ› Bug Fixes
  ðŸ“š Documentation
  â™»ï¸ Refactoring
  ðŸŽ¨ Styling
  ðŸ§ª Testing
  ðŸ”§ Chores & CI
end note

' ========================================
' STATISTICS BOX
' ========================================

rectangle "Pipeline Statistics\n\n" as Stats #FFFACD {
    rectangle "**Node Version:** 22.x\n**Total Workflows:** 6\n**Total Jobs:** 12\n**Environments:** 3\n\n" as Stats1
    rectangle "**Secrets per Env:** 46\n**Docker Images:** 5 tags\n**Max Timeout:** 20 min\n**Cache Strategy:** GHA\n**Custom Actions:** 2\n\n" as Stats2
}

Stats -[hidden]-> DevServer

@enduml
