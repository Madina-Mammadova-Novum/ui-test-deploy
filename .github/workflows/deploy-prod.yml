name: Deploy to Production

# ðŸŽ¯ Triggers: When PR from release/yyyymmdd-count or hotfix/* is merged to 'main' branch
on:
  push:
    branches:
      - main
    paths:
      # Only deploy when actual application code changes
      - '**/*.js'
      - '**/*.jsx'
      - 'package.json'
      - 'yarn.lock'
      - 'next.config.js'
      - 'tailwind.config.js'
      - 'postcss.config.js'
      - 'components/**'
      - 'pages/**'
      - 'app/**'
      - 'lib/**'
      - 'utils/**'
      - 'services/**'
      - 'store/**'
      - 'adapters/**'
      - 'models/**'
      - 'public/**'
      - 'assets/**'
      - 'Dockerfile.ci'
      - '.github/workflows/deploy-prod.yml'
      - '.github/workflows/deploy-reusable.yml'

  # Allow manual deployment trigger from GitHub UI
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual deployment'
        required: true
        default: 'Manual production deployment'
      skip-health-checks:
        description: 'Skip health checks (emergency only)'
        required: false
        type: boolean
        default: false

# Prevent multiple deployments from running simultaneously
# CRITICAL: Production deployments must not overlap
concurrency:
  group: deploy-prod
  cancel-in-progress: false # Never cancel production deployments

jobs:
  # ============================================================================
  # JOB 1: VALIDATE SOURCE BRANCH
  # ============================================================================
  validate:
    name: Validate Deployment Source
    runs-on: ubuntu-latest
    timeout-minutes: 2
    permissions:
      contents: read # Read commit history for validation

    outputs:
      is-valid: ${{ steps.check.outputs.is-valid }}
      source-branch: ${{ steps.check.outputs.source-branch }}
      release-version: ${{ steps.check.outputs.release-version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 10 # Fetch recent commits to check merge source

      - name: Validate merge source branch
        id: check
        run: |
          # For manual triggers, skip validation but log warning
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "âš ï¸ MANUAL DEPLOYMENT - Skipping branch validation"
            echo "is-valid=true" >> $GITHUB_OUTPUT
            echo "source-branch=manual-trigger" >> $GITHUB_OUTPUT
            echo "release-version=manual-$(date +%Y%m%d-%H%M)" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get the commit message of the merge commit
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "ðŸ“ Commit message: $COMMIT_MSG"

          # Extract source branch from merge commit message
          # GitHub merge commits have format: "Merge pull request #123 from org/branch-name"
          if echo "$COMMIT_MSG" | grep -q "Merge pull request"; then
            SOURCE_BRANCH=$(echo "$COMMIT_MSG" | grep -oP 'from \S+/\K\S+' || echo "unknown")
            echo "ðŸ” Detected source branch: $SOURCE_BRANCH"
          else
            # Direct push or squash merge - check ref name
            SOURCE_BRANCH="${GITHUB_REF_NAME}"
            echo "ðŸ” Using ref name as source: $SOURCE_BRANCH"
          fi

          # Validate branch name matches allowed patterns
          if [[ "$SOURCE_BRANCH" =~ ^release/[0-9]{8}-[0-9]+$ ]] || [[ "$SOURCE_BRANCH" =~ ^hotfix/.+ ]]; then
            echo "âœ… Valid source branch: $SOURCE_BRANCH"
            echo "is-valid=true" >> $GITHUB_OUTPUT
            echo "source-branch=$SOURCE_BRANCH" >> $GITHUB_OUTPUT
            
            # Extract release version from branch name
            if [[ "$SOURCE_BRANCH" =~ ^release/([0-9]{8}-[0-9]+)$ ]]; then
              RELEASE_VERSION="${BASH_REMATCH[1]}"
              echo "release-version=$RELEASE_VERSION" >> $GITHUB_OUTPUT
              echo "ðŸ“¦ Release version: $RELEASE_VERSION"
            elif [[ "$SOURCE_BRANCH" =~ ^hotfix/(.+)$ ]]; then
              HOTFIX_NAME="${BASH_REMATCH[1]}"
              RELEASE_VERSION="hotfix-${HOTFIX_NAME}-$(date +%Y%m%d)"
              echo "release-version=$RELEASE_VERSION" >> $GITHUB_OUTPUT
              echo "ðŸš¨ Hotfix version: $RELEASE_VERSION"
            fi
          else
            echo "âŒ INVALID SOURCE BRANCH: $SOURCE_BRANCH"
            echo "âŒ Production deployments only allowed from:"
            echo "   - release/yyyymmdd-count (e.g., release/20251010-1)"
            echo "   - hotfix/* (e.g., hotfix/critical-fix)"
            echo ""
            echo "Current source: $SOURCE_BRANCH"
            echo "is-valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Generate validation summary
        if: always()
        run: |
          echo "# ðŸ” Deployment Source Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check.outputs.is-valid }}" = "true" ]; then
            echo "## âœ… Validation Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Source Branch:** \`${{ steps.check.outputs.source-branch }}\`" >> $GITHUB_STEP_SUMMARY
            echo "**Release Version:** \`${{ steps.check.outputs.release-version }}\`" >> $GITHUB_STEP_SUMMARY
            echo "**Deployment Type:** Production" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Validation Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Error:** Invalid source branch for production deployment" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Allowed branches:**" >> $GITHUB_STEP_SUMMARY
            echo "- \`release/yyyymmdd-count\` (e.g., release/20251010-1)" >> $GITHUB_STEP_SUMMARY
            echo "- \`hotfix/*\` (e.g., hotfix/critical-security-fix)" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # JOB 2: CALL REUSABLE DEPLOYMENT WORKFLOW
  # ============================================================================
  deploy:
    name: Deploy to Production
    needs: validate
    if: needs.validate.outputs.is-valid == 'true'
    uses: ./.github/workflows/deploy-reusable.yml
    with:
      environment: prod
      image-tag-suffix: prod-latest
      deployment-reason: ${{ github.event.inputs.reason || format('Production deployment from {0}', needs.validate.outputs.source-branch) }}
      release-version: ${{ needs.validate.outputs.release-version }}
      skip-health-checks: ${{ github.event.inputs.skip-health-checks || false }}
    secrets: inherit # Pass all secrets from the calling workflow to the reusable workflow

