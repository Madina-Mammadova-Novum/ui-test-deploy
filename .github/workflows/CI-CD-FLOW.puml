@startuml ShipLink Frontend CI/CD Pipeline
!define BLUE #3B82F6
!define PURPLE #8B5CF6
!define GREEN #10B981
!define TEAL #14B8A6
!define AMBER #F59E0B
!define RED #EF4444
!define LIGHTGREEN #22C55E

title ShipLink Frontend - Complete CI/CD Pipeline Architecture

skinparam backgroundColor #FFFFFF
skinparam rectangleBackgroundColor<<PR>> BLUE
skinparam rectangleBackgroundColor<<Commit>> PURPLE
skinparam rectangleBackgroundColor<<Build>> GREEN
skinparam rectangleBackgroundColor<<Deploy>> TEAL
skinparam rectangleBackgroundColor<<Health>> AMBER
skinparam rectangleBackgroundColor<<Validate>> RED
skinparam rectangleBackgroundColor<<Success>> LIGHTGREEN

' ========================================
' SECTION 1: PR VALIDATION WORKFLOWS
' ========================================

package "Pull Request Workflows" <<PR>> {
    rectangle "PR Validation\n(pr-validation.yml)" as PRVal {
        rectangle "Trigger:\n‚Ä¢ pull_request to any branch\n‚Ä¢ Skip draft PRs\n‚Ä¢ Path filtering enabled" as PRTrigger
        
        package "Parallel Jobs" {
            rectangle "Job 1: Code Quality & Build\nTimeout: 15min\nPermissions: contents:read, pr:write" as Job1 {
                rectangle "Steps:\n1. Checkout code\n2. Setup Node.js 22.x\n3. Install dependencies\n4. Create .env.local (CI)\n5. Cache Next.js build\n6. Cache ESLint\n7. Run ESLint ‚úì\n8. Check Prettier ‚úì\n9. Build project ‚úì\n10. Run tests (optional)\n11. Check bundle size\n12. Generate summary\n13. Post PR comment (fail)" as Job1Steps
            }
            
            rectangle "Job 2: Security Scan\nTimeout: 10min\nPermissions: contents:read" as Job2 {
                rectangle "Steps:\n1. Checkout code\n2. Setup Node.js 22.x\n3. Install dependencies\n4. Create .env.local (CI)\n5. Run yarn audit\n6. Check critical vulns\n7. Report high vulns\n8. Check outdated packages\n9. Generate security summary" as Job2Steps
            }
            
            rectangle "Job 3: Performance Check\nTimeout: 5min\nPermissions: contents:read" as Job3 {
                rectangle "Steps:\n1. Checkout code\n2. Setup Node.js 22.x\n3. Install dependencies\n4. Create .env.local (CI)\n5. Build & analyze bundle\n6. Generate perf summary" as Job3Steps
            }
        }
        
        rectangle "Optimizations:\n‚ö° Cache v4\nüéØ Path filtering\nüìù Draft skip\nüîí Least privilege\nüí¨ PR comments" as PROptim
    }
    
    rectangle "Commit Validation\n(commit-validation.yml)" <<Commit>> as CommitVal {
        rectangle "Trigger:\n‚Ä¢ PR to develop only\n‚Ä¢ Path filtering enabled" as CommitTrigger
        
        rectangle "Job: Validate Commits\nTimeout: 5min\nPermissions: contents:read, pr:read" as CommitJob {
            rectangle "Steps:\n1. Checkout (fetch-depth:0)\n2. Setup Node.js 22.x\n3. Install dependencies\n4. Run commitlint\n5. Validate format" as CommitSteps
        }
        
        rectangle "Conventional Commits:\nfeat:, fix:, docs:, refactor:\nScopes: owner, charterer,\nvessel, cargo, ui, api" as CommitFormat
    }
}

' ========================================
' SECTION 2: BRANCH FLOW
' ========================================

package "Branch Strategy & Flow" {
    rectangle "feature/*" as Feature
    rectangle "develop" as Develop #LightBlue
    rectangle "stage" as Stage #LightYellow
    rectangle "release/yyyymmdd-count" as Release #Orange
    rectangle "hotfix/*" as Hotfix #Red
    rectangle "main" as Main #LightGreen
    
    Feature -right-> Develop : PR merge
    Feature -right-> Stage : PR merge
    Develop -down-> Stage : PR merge
    Stage -down-> Release : create branch
    Release -down-> Main : PR merge\n(validation required)
    Hotfix -down-> Main : PR merge\n(emergency only)
    
    rectangle "DEV Environment\n‚úì Auto-deploy" as DevEnv #SkyBlue
    rectangle "STAGE Environment\n‚úì Auto-deploy" as StageEnv #Yellow
    rectangle "PROD Environment\n‚ö†Ô∏è Manual approval\n‚úì Health checks" as ProdEnv #LightCoral
    
    Develop --> DevEnv
    Stage --> StageEnv
    Main --> ProdEnv
}

' ========================================
' SECTION 3: DEPLOYMENT WORKFLOWS
' ========================================

package "Continuous Deployment" <<Deploy>> {
    
    rectangle "Deploy to Development\n(deploy-dev.yml)" as DeployDev {
        rectangle "Trigger:\n‚Ä¢ Push to develop\n‚Ä¢ Manual workflow_dispatch" as DevTrigger
        rectangle "Calls: deploy-reusable.yml\nParams:\n‚Ä¢ environment: dev\n‚Ä¢ image-tag-suffix: dev-latest\n‚Ä¢ app-url: DEV_APP_URL" as DevCall
    }
    
    rectangle "Deploy to Staging\n(deploy-stage.yml)" as DeployStage {
        rectangle "Trigger:\n‚Ä¢ Push to stage\n‚Ä¢ Manual workflow_dispatch" as StageTrigger
        rectangle "Calls: deploy-reusable.yml\nParams:\n‚Ä¢ environment: stage\n‚Ä¢ image-tag-suffix: stage-latest\n‚Ä¢ app-url: STAGE_APP_URL" as StageCall
    }
    
    rectangle "Deploy to Production\n(deploy-prod.yml)" <<Validate>> as DeployProd {
        rectangle "Trigger:\n‚Ä¢ Push to main from release/* or hotfix/*\n‚Ä¢ Manual workflow_dispatch" as ProdTrigger
        
        rectangle "Job 1: Validate Source\nTimeout: 2min" as ValidateJob {
            rectangle "Steps:\n1. Checkout code\n2. Validate branch name\n3. Must be: release/* or hotfix/*\n4. Extract release version\n5. Generate validation summary" as ValidateSteps
            rectangle "Outputs:\n‚Ä¢ is-valid\n‚Ä¢ source-branch\n‚Ä¢ release-version" as ValidateOutput
        }
        
        rectangle "If valid ‚úì\nCalls: deploy-reusable.yml\nParams:\n‚Ä¢ environment: prod\n‚Ä¢ release-version: yyyymmdd-count\n‚Ä¢ skip-health-checks: false" as ProdCall
    }
}

' ========================================
' SECTION 4: REUSABLE DEPLOYMENT WORKFLOW
' ========================================

package "Reusable Deployment Pipeline\n(deploy-reusable.yml)" <<Build>> {
    
    rectangle "Job 1: Build & Push Docker Image\nTimeout: 20min\nEnvironment: ${environment}" as BuildJob {
        rectangle "Build Steps:" as BuildSteps {
            rectangle "1. Checkout code\n   fetch-depth: 0" as B1
            rectangle "2. Generate metadata\n   ‚Ä¢ image-tag: SHA:0:8\n   ‚Ä¢ deployment-time: UTC\n   ‚Ä¢ release-version (prod)" as B2
            rectangle "3. Login to ACR\n   ‚Ä¢ registry: ACR_REGISTRY_URL\n   ‚Ä¢ username: ACR_USERNAME\n   ‚Ä¢ password: ACR_PASSWORD" as B3
            rectangle "4. Setup Docker Buildx" as B4
            rectangle "5. Build & tag image\n   ‚Ä¢ file: Dockerfile.ci\n   ‚Ä¢ tags: SHA, env-latest, release-*\n   ‚Ä¢ build-args: 38 env vars\n   ‚Ä¢ cache: type=gha" as B5
            rectangle "6. Push to registry" as B6
            rectangle "7. Verify image" as B7
            
            B1 -down-> B2
            B2 -down-> B3
            B3 -down-> B4
            B4 -down-> B5
            B5 -down-> B6
            B6 -down-> B7
        }
        
        rectangle "Outputs:\n‚Ä¢ image-tag\n‚Ä¢ deployment-time\n‚Ä¢ release-version" as BuildOutput
    }
    
    rectangle "Job 2: Deploy to Server\nTimeout: 10min\nNeeds: build" as DeployJob {
        rectangle "Deploy Steps:" as DeploySteps {
            rectangle "1. Setup SSH\n   ‚Ä¢ Method: key or password\n   ‚Ä¢ Add to known_hosts\n   ‚Ä¢ Configure auth" as D1
            
            rectangle "2. Deploy via SSH\nRemote script execution:" as D2 {
                rectangle "a. Login to ACR from server" as D2a
                rectangle "b. Pull new image" as D2b
                rectangle "c. Tag old image for rollback\n   ${container}-previous" as D2c
                rectangle "d. Stop old container\n   docker stop" as D2d
                rectangle "e. Remove old container\n   docker rm" as D2e
                rectangle "f. Start new container\n   docker run -d\n   --restart always\n   -p 3000:3000\n   -e (38 vars)" as D2f
                rectangle "g. Wait 30 seconds" as D2g
                rectangle "h. Verify running\n   docker ps" as D2h
                
                D2a -down-> D2b
                D2b -down-> D2c
                D2c -down-> D2d
                D2d -down-> D2e
                D2e -down-> D2f
                D2f -down-> D2g
                D2g -down-> D2h
            }
            
            rectangle "i. If FAIL ‚Üí Rollback\n   Start ${container}-previous" as D2i <<Validate>>
            rectangle "j. Cleanup old images\n   prune >72h" as D2j
            
            D1 -down-> D2
            D2 -down-> D2i
            D2i -down-> D2j
        }
        
        rectangle "3. Generate summary\n   ‚Ä¢ Deployment status\n   ‚Ä¢ Access URL" as D3
    }
    
    rectangle "Job 3: Health Checks\n(PRODUCTION ONLY)\nTimeout: 10min\nNeeds: deploy" <<Health>> as HealthJob {
        rectangle "Condition:\nif environment == 'prod'\n&& !skip-health-checks" as HealthCondition
        
        rectangle "Health Check Steps:" as HealthSteps {
            rectangle "1. Wait 60s for stabilization" as H1
            
            rectangle "2. Run health checks (2 retries, 5s delay):" as H2 {
                rectangle "Check 1: Home Page\n   GET /\n   Expected: 200 OK" as H2a
                rectangle "Check 2: API Health\n   GET /api/health\n   Expected: 200 OK" as H2b
                rectangle "Check 3: Auth Service\n   GET /api/account/info\n   Expected: 200 or 401" as H2c
                rectangle "Check 4: Protected API\n   GET /v1/charterer/vessels\n   Expected: 401" as H2d
                
                H2a -down-> H2b
                H2b -down-> H2c
                H2c -down-> H2d
            }
            
            H1 -down-> H2
        }
        
        rectangle "3. If ANY fail ‚Üí Rollback\n   a. SSH to server\n   b. Stop failed container\n   c. Start previous\n   d. Wait 15s\n   e. Verify success" as H3 <<Validate>>
        
        rectangle "4. Generate health summary\n   ‚Ä¢ Test results\n   ‚Ä¢ Rollback status" as H4
    }
}

' ========================================
' SECTION 5: RELEASE MANAGEMENT
' ========================================

package "Release Management Flow" {
    rectangle "1. Create Milestone\n   ‚Ä¢ Title: Release yyyy-mm-dd\n   ‚Ä¢ Due date: Target date\n   ‚Ä¢ Description: Goals" as Milestone1
    
    rectangle "2. Assign Issues\n   ‚Ä¢ Features\n   ‚Ä¢ Bugs\n   ‚Ä¢ Enhancements" as Milestone2
    
    rectangle "3. Development\n   ‚Ä¢ Feature branches\n   ‚Ä¢ PR to develop\n   ‚Ä¢ Deploy to DEV" as Milestone3
    
    rectangle "4. QA Testing\n   ‚Ä¢ Merge to stage\n   ‚Ä¢ Deploy to STAGE\n   ‚Ä¢ QA sign-off" as Milestone4
    
    rectangle "5. Create Release Branch\n   ‚Ä¢ format: release/yyyymmdd-count\n   ‚Ä¢ from: stage\n   ‚Ä¢ Final testing" as Milestone5
    
    rectangle "6. Production Deployment\n   ‚Ä¢ PR to main\n   ‚Ä¢ Branch validation ‚úì\n   ‚Ä¢ Manual approval ‚ö†Ô∏è\n   ‚Ä¢ Deploy with health checks\n   ‚Ä¢ Close milestone" as Milestone6
    
    Milestone1 -right-> Milestone2
    Milestone2 -down-> Milestone3
    Milestone3 -right-> Milestone4
    Milestone4 -down-> Milestone5
    Milestone5 -right-> Milestone6
}

' ========================================
' SECTION 6: GITHUB ENVIRONMENTS
' ========================================

package "GitHub Environments & Secrets" {
    rectangle "Environment: DEV" as EnvDev {
        rectangle "Registry Secrets: 3\n‚Ä¢ ACR_REGISTRY_URL\n‚Ä¢ ACR_USERNAME\n‚Ä¢ ACR_PASSWORD" as DevReg
        rectangle "SSH Secrets: 4\n‚Ä¢ SSH_HOST\n‚Ä¢ SSH_USERNAME\n‚Ä¢ SSH_PORT\n‚Ä¢ SSH_PRIVATE_KEY" as DevSSH
        rectangle "App Secrets: 38\nEnvironment variables" as DevApp
        rectangle "Protection: None\nAuto-deploy: ‚úì" as DevProt
    }
    
    rectangle "Environment: STAGE" as EnvStage {
        rectangle "Registry Secrets: 3\n(same as DEV)" as StageReg
        rectangle "SSH Secrets: 4\n(different server)" as StageSSH
        rectangle "App Secrets: 38\nStage-specific values" as StageApp
        rectangle "Protection: Optional\nAuto-deploy: ‚úì" as StageProt
    }
    
    rectangle "Environment: PROD" as EnvProd {
        rectangle "Registry Secrets: 3\n(same registry)" as ProdReg
        rectangle "SSH Secrets: 4\n(production server)" as ProdSSH
        rectangle "App Secrets: 38\nProduction values" as ProdApp
        rectangle "Protection:\n‚úì Required reviewers: 1+\n‚úì Branch: main only\nAuto-deploy: ‚ö†Ô∏è with approval" as ProdProt
    }
}

' ========================================
' SECTION 7: METRICS & OPTIMIZATIONS
' ========================================

package "Performance Metrics" <<Success>> {
    rectangle "Optimization Results:" as Metrics {
        rectangle "‚Ä¢ 60% faster PR CI time\n‚Ä¢ 80% cache hit rate\n‚Ä¢ 85% reduction unnecessary runs\n‚Ä¢ 100% docs changes skipped\n‚Ä¢ 60% cost savings monthly" as MetricsList
    }
    
    rectangle "Cache Strategy:" as Cache {
        rectangle "‚Ä¢ Actions Cache v4\n‚Ä¢ Next.js build cache\n‚Ä¢ ESLint cache\n‚Ä¢ Node modules cache\n‚Ä¢ Docker layer cache (GHA)" as CacheList
    }
    
    rectangle "Path Filtering:" as PathFilter {
        rectangle "Runs on:\n‚úì **/*.js, **/*.jsx\n‚úì package.json, yarn.lock\n‚úì Config files\n‚úì Source directories" as PathRuns
        rectangle "Skips:\n‚è≠Ô∏è **/*.md, docs/**\n‚è≠Ô∏è .github/workflows/**\n‚è≠Ô∏è LICENSE, .gitignore" as PathSkips
    }
}

' ========================================
' CONNECTIONS
' ========================================

PRVal -down-> Feature : PR approved
CommitVal -down-> Develop : Commits validated

DevEnv -down-> DeployDev
StageEnv -down-> DeployStage
ProdEnv -down-> DeployProd

DeployDev -down-> BuildJob
DeployStage -down-> BuildJob
DeployProd -down-> BuildJob

BuildJob -down-> DeployJob
DeployJob -down-> HealthJob : only prod

Release -down-> Milestone5 : creates
Main -down-> Milestone6 : completes

@enduml

