@startuml CI-CD Pipeline

title ShipLink Frontend - CI/CD Pipeline (Complete)

skinparam backgroundColor #FFFFFF
skinparam padding 6
skinparam arrowThickness 2
skinparam defaultFontSize 10

' PR VALIDATION
package "PR Workflows" #3B82F6 {
    rectangle "pr-validation.yml" as PRVal #DDDDFF {
        rectangle "Code Quality\n+ Security\n+ Performance" as PRJobs #EEEEFF
    }
    
    rectangle "commit-validation.yml" as CommitVal #EEDDFF {
        rectangle "Conventional Commits\nfeat/fix/docs/etc" as CommitCheck #EEEEFF
    }
}

' BRANCH STRATEGY
package "Git Flow" #8B5CF6 {
    rectangle "feature/*" as Feature #White
    rectangle "develop" as Develop #LightBlue
    rectangle "stage" as Stage #LightYellow
    rectangle "release/*" as Release #Orange
    rectangle "main" as Main #LightGreen
    rectangle "hotfix/*" as Hotfix #LightCoral
    
    Feature --> Develop : PR
    Develop --> Stage : PR
    Stage --> Release : branch
    Release --> Main : PR + Approval
    Main --> Hotfix : emergency
    Hotfix --> Main : PR
}

' DEPLOYMENTS
package "Deployments" #10B981 {
    rectangle "deploy-dev.yml" as DeployDev #DDFFDD {
        rectangle "Auto-deploy\nto DEV" as DevDeploy #EEFFEE
    }
    
    rectangle "deploy-stage.yml" as DeployStage #FFFFDD {
        rectangle "Auto-deploy\nto STAGE" as StageDeploy #FFFFEE
    }
    
    rectangle "deploy-prod.yml" as DeployProd #FFDDDD {
        rectangle "Validate Branch\n↓\nBuild Image\n↓\nRequest Approval" as ProdFlow #FFEEEE
    }
}

' APPROVAL & RELEASE
package "Production Approval" #EC4899 {
    rectangle "approve-deploy-prod.yml" as ApprovalWF #FFDDEE {
        rectangle "Parse Issue\n↓\nDeploy\n↓\nHealth Checks\n↓\nCreate Release\n↓\nUpdate Issue" as ApprovalFlow #FFEEEE
    }
    
    rectangle "Release Creation" as ReleaseAction #FFDDEE {
        rectangle "Generate Notes\n+ Tag Version\n+ Link PRs\n+ List Contributors" as ReleaseDetails #FFEEEE
    }
}

' REUSABLE WORKFLOW
package "deploy-reusable.yml" #14B8A6 {
    rectangle "Build Job" as BuildJob #DDFFDD {
        rectangle "Checkout\n+ Generate Metadata\n+ ACR Login\n+ Docker Build\n+ Push Image" as BuildSteps #EEFFEE
    }
    
    rectangle "Deploy Job" as DeployJob #DDEEFF {
        rectangle "SSH Setup\n+ Pull Image\n+ Backup Old\n+ Deploy New\n+ Verify\n+ Rollback (if fail)" as DeploySteps #EEEEFF
    }
    
    rectangle "Health Checks\n(PROD only)" as HealthJob #FFFFDD {
        rectangle "Test Home\n+ Test API\n+ Test Auth\n+ Auto Rollback" as HealthSteps #FFFFEE
    }
    
    BuildJob --> DeployJob
    DeployJob --> HealthJob
}

' EXTERNAL SERVICES
package "GitHub Services" #F59E0B {
    rectangle "Issues" as GHIssues #FFFFDD {
        rectangle "Approval Tracking\n+ Status Updates" as IssueFlow #FFFFEE
    }
    
    rectangle "Releases" as GHReleases #FFDDEE {
        rectangle "Version Tags\n+ Changelogs\n+ Contributors" as ReleaseFlow #FFEEEE
    }
    
    rectangle "ACR" as ACR #DDEEFF {
        rectangle "Docker Images\n+ Multi-tags\n+ Auto Cleanup" as ACRFlow #EEEEFF
    }
}

' ENVIRONMENTS
package "Environments" #22C55E {
    rectangle "DEV" as EnvDev #DDFFDD {
        rectangle "Auto-deploy\n46 Secrets" as DevSecrets #EEFFEE
    }
    
    rectangle "STAGE" as EnvStage #FFFFDD {
        rectangle "Auto-deploy\n46 Secrets" as StageSecrets #FFFFEE
    }
    
    rectangle "PROD" as EnvProd #FFDDDD {
        rectangle "Manual Approval\n46 Secrets" as ProdSecrets #FFEEEE
    }
}

' WORKFLOW CONNECTIONS
PRVal --> Feature : validates
CommitVal --> Develop : validates commits

Develop --> DeployDev : triggers
Stage --> DeployStage : triggers
Main --> DeployProd : triggers (release/hotfix only)

DeployDev --> BuildJob : calls
DeployStage --> BuildJob : calls
DeployProd --> GHIssues : creates approval issue

GHIssues --> ApprovalWF : deploy-approved label
ApprovalWF --> BuildJob : deploys
ApprovalWF --> ReleaseAction : generates
ReleaseAction --> GHReleases : creates release

BuildJob --> ACR : pushes images
EnvDev --> ACR : pulls images
EnvStage --> ACR : pulls images
EnvProd --> ACR : pulls images

@enduml
