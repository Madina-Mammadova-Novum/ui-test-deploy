name: Deploy to Staging

# ðŸŽ¯ Triggers: When PR is merged to 'stage' branch
on:
  push:
    branches:
      - stage
    paths:
      # Only deploy when actual application code changes
      - '**/*.js'
      - '**/*.jsx'
      - 'package.json'
      - 'yarn.lock'
      - 'next.config.js'
      - 'tailwind.config.js'
      - 'postcss.config.js'
      - 'components/**'
      - 'pages/**'
      - 'app/**'
      - 'lib/**'
      - 'utils/**'
      - 'services/**'
      - 'store/**'
      - 'adapters/**'
      - 'models/**'
      - 'public/**'
      - 'assets/**'
      - 'Dockerfile.ci'
      - '.github/workflows/deploy-stage.yml'
      - '.github/workflows/deploy-reusable.yml'

  # Allow manual deployment trigger from GitHub UI
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual deployment'
        required: false
        default: 'Manual deployment'

# Prevent multiple deployments from running simultaneously
concurrency:
  group: deploy-stage
  cancel-in-progress: false # Don't cancel in-progress deployments

jobs:
  # Call the reusable deployment workflow
  deploy:
    name: Deploy to Staging
    uses: ./.github/workflows/deploy-reusable.yml
    with:
      environment: stage
      image-tag-suffix: stage-latest
      deployment-reason: ${{ github.event.inputs.reason || 'Automated deployment from stage branch' }}
