name: PR Validation

on:
  pull_request:
    branches: ['*']
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      # Source code files
      - '**/*.js'
      - '**/*.jsx'

      # Dependencies
      - 'package.json'
      - 'yarn.lock'

      # Configuration files that affect build/lint
      - 'next.config.js'
      - 'tailwind.config.js'
      - 'postcss.config.js'
      - 'jsconfig.json'
      - '.env.example'
      - '.eslintrc'
      - '.eslintignore'
      - '.prettierrc'
      - 'commitlint.config.js'
      - 'next-sitemap.config.js'
      - 'turbo.json'

      # Key source directories
      - 'components/**'
      - 'pages/**'
      - 'app/**'
      - 'public/**'
      - 'assets/**'
      - 'styles/**'
      - 'lib/**'
      - 'utils/**'
      - 'services/**'
      - 'store/**'
      - 'adapters/**'
      - 'models/**'
      - 'middleware.js'
      - 'instrumentation.js'

      # CI scripts that affect builds
      - 'ci/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '22.x'

jobs:
  validate:
    name: Code Quality & Build Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event.pull_request.draft == false
    permissions:
      contents: read # Read repository code for linting and building
      pull-requests: write # Post comments on PR with validation results

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Create environment file for CI
        run: |
          cat > .env.local << 'EOF'
          # Core Application URLs
          NEXT_PUBLIC_URL=http://localhost:3000
          NEXT_PUBLIC_API_URL=http://localhost:8080/api
          NEXT_PUBLIC_ADMIN_URL=http://localhost:8080/admin

          # Environment Configuration
          APP_ENV=ci
          NEXT_PUBLIC_APP_ENV=ci
          NODE_ENV=production

          # Authentication & Security
          NEXTAUTH_SECRET=dummy-nextauth-secret-for-ci-builds-only
          NEXTAUTH_URL=http://localhost:3000
          PREVIEW_SECRET=dummy-preview-secret-for-ci

          # reCAPTCHA Configuration
          NEXT_PUBLIC_RECAPTCHA_SITE_KEY=6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI
          RECAPTCHA_SECRET_KEY=6LeIxAcTAAAAAGG-vFI1TnRWxMZNFuojJ4WifJWe

          # Backend Services
          BACKEND_API_URL=http://localhost:8080/api
          IDENTITY_API_URL=http://localhost:8080/identity
          NEXT_PUBLIC_FILE_API_URL=http://localhost:8080/files

          # Strapi CMS
          NEXT_PUBLIC_STRAPI_API_URL=http://localhost:1337/api

          # Real-time Communication
          NEXT_PUBLIC_RT_URL=http://localhost:8080/hubs

          # Seametrix Maritime Data
          NEXT_PUBLIC_SEAMETRIX_API_URL=http://localhost:8080/seametrix
          NEXT_PUBLIC_SEAMETRIX_KEY=dummy-seametrix-key-12345
          NEXT_PUBLIC_SEAMETRIX_MAP_KEY=dummy-seametrix-map-key-67890
          SEAMETRIX_API_URL=http://localhost:8080/seametrix
          SEAMETRIX_MAP_KEY=dummy-seametrix-map-key-67890

          # Identity API Configuration
          IDENTITY_API_CLIENT_ID=dummy-client-id
          IDENTITY_API_CLIENT_SECRET=dummy-client-secret-guid-12345678
          IDENTITY_API_GRANT_TYPE=password
          IDENTITY_TOKEN_GRANT_TYPE=refresh_token

          # Container Registry (not needed for CI builds)
          CONTAINER_REGISTRY_SERVICE_CONNECTION=dummy-registry-connection
          DOCKER_IMAGE_REPO=dummy-registry.azurecr.io
          IMAGE_REPOSITORY=dummy-frontend

          # New Relic Monitoring
          IDENTITY_NEW_RELIC_APP_NAME=shiplink-frontend-ci
          IDENTITY_NEW_RELIC_LICENSE_KEY=dummy-license-key-12345
          NEXT_PUBLIC_NEW_RELIC_BROWSER_LICENSE_KEY=dummy-browser-license-key
          NEXT_PUBLIC_NEW_RELIC_BROWSER_APP_ID=123456789
          NEXT_PUBLIC_NEW_RELIC_BROWSER_AGENT_ID=123456789
          NEXT_PUBLIC_NEW_RELIC_BROWSER_TRUST_KEY=1234567
          NEXT_PUBLIC_NEW_RELIC_BROWSER_ACCOUNT_ID=1234567

          # OpenTelemetry Configuration
          OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318/v1/traces
          OTEL_METRIC_EXPORTER_OTLP_ENDPOINT=http://localhost:4318/v1/metrics

          # Feature Flags
          NEXT_PUBLIC_MAINTENANCE_MODE=false
          NEXT_PUBLIC_BETA_MODE=false
          NEXT_PUBLIC_ENABLE_MATOMO=false
          EOF

      - name: Check Node.js and Yarn versions
        run: |
          echo "Node.js version: $(node --version)"
          echo "Yarn version: $(yarn --version)"

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-

      - name: Cache ESLint
        uses: actions/cache@v4
        with:
          path: .next/cache/eslint
          key: ${{ runner.os }}-nextjs-eslint-${{ hashFiles('.eslintrc', '.eslintignore') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-eslint-

      - name: Run ESLint
        id: eslint
        run: |
          if yarn lint; then
            echo "ESLint passed"
            echo "eslint_passed=true" >> $GITHUB_OUTPUT
          else
            echo "ESLint failed"
            echo "eslint_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Check Prettier formatting
        id: prettier
        run: |
          if yarn format --check; then
            echo "Prettier check passed"
            echo "prettier_passed=true" >> $GITHUB_OUTPUT
          else
            echo "Prettier check failed"
            echo "prettier_passed=false" >> $GITHUB_OUTPUT
            echo ""
            echo "ðŸ’¡ To fix formatting issues, run: yarn format"
            exit 1
          fi

      - name: Build project
        id: build
        run: |
          if yarn build; then
            echo "Build successful"
            echo "build_passed=true" >> $GITHUB_OUTPUT
          else
            echo "Build failed"
            echo "build_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Check test coverage (if tests exist)
        id: test
        run: |
          if [ -f "package.json" ] && grep -q '"test"' package.json; then
            if yarn test --coverage --watchAll=false; then
              echo "Tests passed"
              echo "test_passed=true" >> $GITHUB_OUTPUT
            else
              echo "Tests failed"
              echo "test_passed=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "No test script found, skipping tests"
            echo "test_passed=skipped" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Check bundle size
        id: bundle
        run: |
          if [ -f "package.json" ] && grep -q '"build:analyze"' package.json; then
            yarn build:analyze
            echo "Bundle analysis completed"
            echo "bundle_passed=true" >> $GITHUB_OUTPUT
          else
            echo "No bundle analysis script found"
            echo "bundle_passed=skipped" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Generate workflow summary
        if: always()
        run: |
          echo "# ðŸ“Š PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Code Quality Checks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ESLint
          if [ "${{ steps.eslint.outputs.eslint_passed }}" = "true" ]; then
            echo "âœ… **ESLint**: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.eslint.outputs.eslint_passed }}" = "false" ]; then
            echo "âŒ **ESLint**: Failed - Code style issues detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "yarn lint --fix" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Prettier
          if [ "${{ steps.prettier.outputs.prettier_passed }}" = "true" ]; then
            echo "âœ… **Prettier**: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.prettier.outputs.prettier_passed }}" = "false" ]; then
            echo "âŒ **Prettier**: Failed - Formatting issues detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "yarn format" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Build
          if [ "${{ steps.build.outputs.build_passed }}" = "true" ]; then
            echo "âœ… **Build**: Successful" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.build.outputs.build_passed }}" = "false" ]; then
            echo "âŒ **Build**: Failed - Compilation errors" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Tests
          if [ "${{ steps.test.outputs.test_passed }}" = "true" ]; then
            echo "âœ… **Tests**: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.test.outputs.test_passed }}" = "false" ]; then
            echo "âŒ **Tests**: Failed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.test.outputs.test_passed }}" = "skipped" ]; then
            echo "â­ï¸ **Tests**: Skipped (no test script found)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View full workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

      - name: Generate PR comment
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            let comment = '## ðŸš¨ PR Validation Failed\n\n';
            comment += '### ðŸ“‹ Results\n\n';

            // Check ESLint
            if ('${{ steps.eslint.outputs.eslint_passed }}' === 'false') {
              comment += 'âŒ **ESLint**: Code style issues detected\n';
              comment += '```bash\nyarn lint --fix\n```\n\n';
            } else {
              comment += 'âœ… **ESLint**: Passed\n\n';
            }

            // Check Prettier
            if ('${{ steps.prettier.outputs.prettier_passed }}' === 'false') {
              comment += 'âŒ **Prettier**: Formatting issues detected\n';
              comment += '```bash\nyarn format\n```\n\n';
            } else {
              comment += 'âœ… **Prettier**: Passed\n\n';
            }

            // Check Build
            if ('${{ steps.build.outputs.build_passed }}' === 'false') {
              comment += 'âŒ **Build**: Compilation failed\n\n';
              comment += 'ðŸ’¡ **Tip**: Check the workflow logs for detailed error messages\n\n';
            } else {
              comment += 'âœ… **Build**: Passed\n\n';
            }

            // Check Tests
            if ('${{ steps.test.outputs.test_passed }}' === 'false') {
              comment += 'âŒ **Tests**: Test failures detected\n\n';
            } else if ('${{ steps.test.outputs.test_passed }}' === 'true') {
              comment += 'âœ… **Tests**: Passed\n\n';
            }

            comment += '---\n\n';
            comment += 'ðŸ“Š [View detailed results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n';
            comment += '*Automatically generated by PR Validation workflow*';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event.pull_request.draft == false
    permissions:
      contents: read # Read package.json and yarn.lock for security audit

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Create environment file for security scan
        run: |
          cat > .env.local << 'EOF'
          # CI Environment Variables for Security Scan
          NODE_ENV=production
          APP_ENV=ci
          NEXT_PUBLIC_APP_ENV=ci
          EOF

      - name: Run yarn audit
        run: |
          echo "ðŸ” Running security audit..."

          # Get audit output and check for critical vulnerabilities
          AUDIT_OUTPUT=$(yarn audit --level critical --json 2>/dev/null || true)
          CRITICAL_COUNT=$(echo "$AUDIT_OUTPUT" | grep -c '"severity":"critical"' || true)

          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "âŒ Critical vulnerabilities found: $CRITICAL_COUNT"
            echo "ðŸ“‹ Full audit report:"
            yarn audit --level moderate || true
            echo ""
            echo "ðŸ’¡ Fix critical vulnerabilities before merging"
            exit 1
          else
            echo "âœ… No critical vulnerabilities found"
            
            # Check for high vulnerabilities
            HIGH_COUNT=$(echo "$AUDIT_OUTPUT" | grep -c '"severity":"high"' || true)
            if [ "$HIGH_COUNT" -gt 0 ]; then
              echo "âš ï¸ High vulnerabilities detected: $HIGH_COUNT (not blocking PR)"
              echo "ðŸ“‹ Full audit report:"
              yarn audit --level moderate || true
              echo ""
              echo "ðŸ’¡ Consider updating dependencies to resolve high vulnerabilities"
              echo "âœ… Only critical vulnerabilities block PRs - PR can proceed"
            else
              echo "âœ… No high vulnerabilities found"
              echo "âœ… Security audit passed - PR can proceed"
            fi
          fi

      - name: Check for outdated packages
        run: |
          echo "ðŸ“¦ Checking for outdated packages..."
          yarn outdated || true
        continue-on-error: true

      - name: Generate security summary
        if: always()
        run: |
          echo "# ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Security audit completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scope**: Critical vulnerabilities only" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Note**: Only critical vulnerabilities will block PRs" >> $GITHUB_STEP_SUMMARY

  performance-check:
    name: Performance Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event.pull_request.draft == false
    permissions:
      contents: read # Read repository code for building and analysis

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Create environment file for performance check
        run: |
          cat > .env.local << 'EOF'
          # Core Application URLs
          NEXT_PUBLIC_URL=http://localhost:3000
          NEXT_PUBLIC_API_URL=http://localhost:8080/api
          NEXT_PUBLIC_ADMIN_URL=http://localhost:8080/admin

          # Environment Configuration
          APP_ENV=ci
          NEXT_PUBLIC_APP_ENV=ci
          NODE_ENV=production

          # Authentication & Security
          NEXTAUTH_SECRET=dummy-nextauth-secret-for-ci-builds-only
          NEXTAUTH_URL=http://localhost:3000
          PREVIEW_SECRET=dummy-preview-secret-for-ci

          # reCAPTCHA Configuration
          NEXT_PUBLIC_RECAPTCHA_SITE_KEY=6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI
          RECAPTCHA_SECRET_KEY=6LeIxAcTAAAAAGG-vFI1TnRWxMZNFuojJ4WifJWe

          # Backend Services
          BACKEND_API_URL=http://localhost:8080/api
          IDENTITY_API_URL=http://localhost:8080/identity
          NEXT_PUBLIC_FILE_API_URL=http://localhost:8080/files

          # Strapi CMS
          NEXT_PUBLIC_STRAPI_API_URL=http://localhost:1337/api

          # Real-time Communication
          NEXT_PUBLIC_RT_URL=http://localhost:8080/hubs

          # Seametrix Maritime Data
          NEXT_PUBLIC_SEAMETRIX_API_URL=http://localhost:8080/seametrix
          NEXT_PUBLIC_SEAMETRIX_KEY=dummy-seametrix-key-12345
          NEXT_PUBLIC_SEAMETRIX_MAP_KEY=dummy-seametrix-map-key-67890
          SEAMETRIX_API_URL=http://localhost:8080/seametrix
          SEAMETRIX_MAP_KEY=dummy-seametrix-map-key-67890

          # Identity API Configuration
          IDENTITY_API_CLIENT_ID=dummy-client-id
          IDENTITY_API_CLIENT_SECRET=dummy-client-secret-guid-12345678
          IDENTITY_API_GRANT_TYPE=password
          IDENTITY_TOKEN_GRANT_TYPE=refresh_token

          # Container Registry (not needed for CI builds)
          CONTAINER_REGISTRY_SERVICE_CONNECTION=dummy-registry-connection
          DOCKER_IMAGE_REPO=dummy-registry.azurecr.io
          IMAGE_REPOSITORY=dummy-frontend

          # New Relic Monitoring
          IDENTITY_NEW_RELIC_APP_NAME=shiplink-frontend-ci
          IDENTITY_NEW_RELIC_LICENSE_KEY=dummy-license-key-12345
          NEXT_PUBLIC_NEW_RELIC_BROWSER_LICENSE_KEY=dummy-browser-license-key
          NEXT_PUBLIC_NEW_RELIC_BROWSER_APP_ID=123456789
          NEXT_PUBLIC_NEW_RELIC_BROWSER_AGENT_ID=123456789
          NEXT_PUBLIC_NEW_RELIC_BROWSER_TRUST_KEY=1234567
          NEXT_PUBLIC_NEW_RELIC_BROWSER_ACCOUNT_ID=1234567

          # OpenTelemetry Configuration
          OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318/v1/traces
          OTEL_METRIC_EXPORTER_OTLP_ENDPOINT=http://localhost:4318/v1/metrics

          # Feature Flags
          NEXT_PUBLIC_MAINTENANCE_MODE=false
          NEXT_PUBLIC_BETA_MODE=false
          NEXT_PUBLIC_ENABLE_MATOMO=false
          EOF

      - name: Build and analyze bundle size
        id: perf_build
        run: |
          echo "ðŸ“Š Analyzing bundle size..."
          yarn build

          # Check if bundle analyzer is available
          if [ -f ".next/static/chunks/webpack.js" ]; then
            echo "âœ… Build completed successfully"
            echo "ðŸ’¡ Consider using @next/bundle-analyzer for detailed bundle analysis"
            echo "perf_passed=true" >> $GITHUB_OUTPUT
          else
            echo "perf_passed=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Generate performance summary
        if: always()
        run: |
          echo "# âš¡ Performance Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.perf_build.outputs.perf_passed }}" = "true" ]; then
            echo "âœ… Performance check completed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Bundle analysis successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Performance check incomplete" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Tip**: Add @next/bundle-analyzer for detailed bundle insights" >> $GITHUB_STEP_SUMMARY
