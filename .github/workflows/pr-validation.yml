name: PR Validation

on:
  pull_request:
    branches: ['*']
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20.x'

jobs:
  validate:
    name: Code Quality & Build Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Check Node.js and Yarn versions
        run: |
          echo "Node.js version: $(node --version)"
          echo "Yarn version: $(yarn --version)"

      - name: Cache Next.js build
        uses: actions/cache@v3
        with:
          path: .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/yarn.lock') }}-${{ hashFiles('**.[jt]s', '**.[jt]sx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/yarn.lock') }}-

      - name: Run ESLint
        id: eslint
        run: |
          if yarn lint; then
            echo "ESLint passed"
            echo "eslint_passed=true" >> $GITHUB_OUTPUT
          else
            echo "ESLint failed"
            echo "eslint_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Check Prettier formatting
        id: prettier
        run: |
          if yarn format --check; then
            echo "Prettier check passed"
            echo "prettier_passed=true" >> $GITHUB_OUTPUT
          else
            echo "Prettier check failed"
            echo "prettier_passed=false" >> $GITHUB_OUTPUT
            echo ""
            echo "ğŸ’¡ To fix formatting issues, run: yarn format"
            exit 1
          fi

      - name: Build project
        id: build
        run: |
          if yarn build; then
            echo "Build successful"
            echo "build_passed=true" >> $GITHUB_OUTPUT
          else
            echo "Build failed"
            echo "build_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Run type check
        id: typecheck
        run: |
          if npx tsc --noEmit; then
            echo "Type check passed"
            echo "typecheck_passed=true" >> $GITHUB_OUTPUT
          else
            echo "Type check failed"
            echo "typecheck_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        continue-on-error: true

      - name: Check test coverage (if tests exist)
        id: test
        run: |
          if [ -f "package.json" ] && grep -q '"test"' package.json; then
            if yarn test --coverage --watchAll=false; then
              echo "Tests passed"
              echo "test_passed=true" >> $GITHUB_OUTPUT
            else
              echo "Tests failed"
              echo "test_passed=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            echo "No test script found, skipping tests"
            echo "test_passed=skipped" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Check bundle size
        id: bundle
        run: |
          if [ -f "package.json" ] && grep -q '"build:analyze"' package.json; then
            yarn build:analyze
            echo "Bundle analysis completed"
            echo "bundle_passed=true" >> $GITHUB_OUTPUT
          else
            echo "No bundle analysis script found"
            echo "bundle_passed=skipped" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Generate PR comment
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            let comment = '## ğŸ” PR Validation Results\n\n';

            // Check ESLint
            if ('${{ steps.eslint.outputs.eslint_passed }}' === 'false') {
              comment += 'âŒ **ESLint**: Failed - Code style issues detected\n';
              comment += '```bash\nyarn lint\n```\n';
            } else {
              comment += 'âœ… **ESLint**: Passed\n';
            }

            // Check Prettier
            if ('${{ steps.prettier.outputs.prettier_passed }}' === 'false') {
              comment += 'âŒ **Prettier**: Failed - Formatting issues detected\n';
              comment += '```bash\nyarn format\n```\n';
            } else {
              comment += 'âœ… **Prettier**: Passed\n';
            }

            // Check Build
            if ('${{ steps.build.outputs.build_passed }}' === 'false') {
              comment += 'âŒ **Build**: Failed - Compilation errors\n';
            } else {
              comment += 'âœ… **Build**: Passed\n';
            }

            // Check TypeScript
            if ('${{ steps.typecheck.outputs.typecheck_passed }}' === 'false') {
              comment += 'âŒ **Type Check**: Failed - Type errors detected\n';
            } else if ('${{ steps.typecheck.outputs.typecheck_passed }}' === 'true') {
              comment += 'âœ… **Type Check**: Passed\n';
            }

            // Check Tests
            if ('${{ steps.test.outputs.test_passed }}' === 'false') {
              comment += 'âŒ **Tests**: Failed\n';
            } else if ('${{ steps.test.outputs.test_passed }}' === 'true') {
              comment += 'âœ… **Tests**: Passed\n';
            }

            comment += '\n---\n';
            comment += '*This comment was automatically generated by the PR validation workflow.*';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run npm audit
        run: |
          if npm audit --audit-level=moderate; then
            echo "âœ… No high or moderate security vulnerabilities found"
          else
            echo "âš ï¸ Security vulnerabilities detected"
            npm audit --audit-level=moderate
            exit 1
          fi

      - name: Check for outdated packages
        run: |
          echo "ğŸ“¦ Checking for outdated packages..."
          yarn outdated || true
        continue-on-error: true

  performance-check:
    name: Performance Check
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build and analyze bundle size
        run: |
          echo "ğŸ“Š Analyzing bundle size..."
          yarn build

          # Check if bundle analyzer is available
          if [ -f ".next/static/chunks/webpack.js" ]; then
            echo "âœ… Build completed successfully"
            echo "ğŸ’¡ Consider using @next/bundle-analyzer for detailed bundle analysis"
          fi
        continue-on-error: true
